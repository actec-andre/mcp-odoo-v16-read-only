name: Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DO_API_TOKEN }}

    - name: Update DigitalOcean App Environment Variables
      run: |
        # Create app spec with secrets from GitHub
        cat > app-spec.yaml << EOF
        name: mcp-odoo-v16
        region: fra

        services:
        - name: odoo-mcp-server
          source_dir: /
          github:
            repo: actec-andre/mcp-odoo-v16-read-only
            branch: main
            deploy_on_push: true

          build_command: ""
          dockerfile_path: Dockerfile

          environment_slug: python
          instance_count: 1
          instance_size_slug: apps-s-1vcpu-0.5gb
          http_port: 8080

          envs:
          - key: ODOO_URL
            value: "${{ secrets.ODOO_URL }}"
          - key: ODOO_DB
            value: "${{ secrets.ODOO_DB }}"
          - key: ODOO_USERNAME
            value: "${{ secrets.ODOO_USERNAME }}"
          - key: ODOO_PASSWORD
            value: "${{ secrets.ODOO_PASSWORD }}"
          - key: ODOO_TIMEOUT
            value: "${{ secrets.ODOO_TIMEOUT }}"
          - key: ODOO_VERIFY_SSL
            value: "${{ secrets.ODOO_VERIFY_SSL }}"
          - key: LOG_LEVEL
            value: "${{ secrets.LOG_LEVEL }}"
          - key: DEPLOYMENT_MODE
            value: "${{ secrets.DEPLOYMENT_MODE }}"
        EOF

        # Update the app
        doctl apps update 2526a933-e82d-4c54-a003-68f7e0d4eb74 --spec app-spec.yaml

    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 120
        doctl apps get 2526a933-e82d-4c54-a003-68f7e0d4eb74